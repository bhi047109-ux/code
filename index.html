<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Encoder / Decoder with External Key</title>
<!-- Embedded SVG favicon to avoid 404 -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%23ffffff'/%3E%3Ctext x='50' y='58' font-size='48' text-anchor='middle' fill='%230b1220' font-family='system-ui,Segoe UI,Roboto,Arial'%3EE%3C/text%3E%3C/svg%3E">
<style>
  :root{ --bg:#ffffff; --panel:#f0f0f0; --fg:#0b1220; --muted:#555555; --accent:#0055cc; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
  .container{max-width:760px;margin:24px auto;padding:16px;border-radius:12px;background:var(--panel);border:1px solid #ccc}
  h1{margin:0 0 12px;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;color:var(--fg)}
  textarea{min-height:120px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  .btnbar{display:flex;gap:8px;margin-top:10px}
  .btn{padding:8px 12px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .ghost{background:transparent;border:1px solid #ccc;color:var(--fg)}
  .status{margin-top:10px;display:flex;gap:12px;font-size:12px;color:var(--muted)}
  pre{min-height:120px;background:#fafafa;border:1px solid #ddd;padding:10px;border-radius:8px;white-space:pre-wrap;overflow-wrap:break-word}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="container" id="app">
  <h1>Encoder / Decoder (External Key)</h1>
  <label>Channel</label>
  <select id="channelSelect"><option value="alpha">alpha</option></select>
  <label style="margin-top:10px">Delimiter</label>
  <input id="delimiter" type="text" value=" " />
  <div class="row" style="margin-top:10px">
    <div>
      <label>Input</label>
      <textarea id="inputArea" placeholder="Type text to encode, or paste tokens to decode"></textarea>
      <div class="btnbar">
        <button id="encodeBtn" class="btn">Encode</button>
        <button id="decodeBtn" class="btn ghost">Decode</button>
      </div>
    </div>
    <div>
      <label>Output</label>
      <pre id="outputBox"></pre>
      <div class="btnbar">
        <button id="copyBtn" class="btn ghost">Copy</button>
      </div>
    </div>
  </div>
  <div class="status">
    <div>Coverage: <span id="coverage">-</span></div>
    <div>Tokens/Len: <span id="tokens">-</span></div>
    <div>Speed: <span id="speed">-</span></div>
    <div>Entropy: <span id="entropy">-</span></div>
  </div>
</div>
<script>
const $ = id => document.getElementById(id);
const now = () => performance.now();

function hexOfChar(ch) {
  const u = new TextEncoder().encode(ch);
  return Array.from(u).map(b => b.toString(16).padStart(2, '0')).join('');
}

function charFromHex(hex) {
  const bytes = hex.match(/.{1,2}/g);
  if (!bytes) return '';
  try {
    return new TextDecoder().decode(new Uint8Array(bytes.map(h => parseInt(h, 16))));
  } catch (e) {
    return '?';
  }
}

function estimateEntropy(s) {
  if (!s) return 0;
  const f = {};
  for (const c of s) f[c] = (f[c] || 0) + 1;
  let H = 0;
  const L = s.length;
  for (const k in f) {
    const p = f[k] / L;
    H -= p * Math.log2(p);
  }
  return H;
}

let KEYMAP = {};

async function loadKey() {
  try {
    const resp = await fetch('key.json');
    if (!resp.ok) throw new Error('Failed to load key.json');
    KEYMAP = await resp.json();
    updateCoverage();
  } catch (e) {
    alert('Error loading key.json: ' + e.message);
  }
}

function updateCoverage() {
  const ch = $('channelSelect').value;
  if (KEYMAP[ch]) {
    $('coverage').textContent = Math.round(Object.keys(KEYMAP[ch]).length / 256 * 100) + '%';
  } else {
    $('coverage').textContent = '-';
  }
}

function encode(channel, delim, text) {
  const t0 = now();
  const map = KEYMAP[channel] || {};
  const toks = [];
  for (const ch of Array.from(text)) {
    if (Object.prototype.hasOwnProperty.call(map, ch)) toks.push(map[ch]);
    else toks.push(`${channel}_UNK_${hexOfChar(ch)}`);
  }
  return { out: toks.join(delim), tokens: toks, elapsed: now() - t0 };
}

function decode(channel, delim, tokenString) {
  const t0 = now();
  const map = KEYMAP[channel] || {};
  const rev = {};
  for (const k in map) rev[map[k]] = k;
  const toks = tokenString ? tokenString.split(delim).filter(Boolean) : [];
  const chars = toks.map(tk => {
    const m = tk.match(/^(.+?)_UNK_([0-9a-fA-F]+)$/);
    if (m) return charFromHex(m[2]);
    if (rev[tk] !== undefined) return rev[tk];
    return '?';
  });
  return { text: chars.join(''), toks, elapsed: now() - t0 };
}

$('encodeBtn').addEventListener('click', () => {
  const ch = $('channelSelect').value;
  const d = $('delimiter').value || ' ';
  const txt = $('inputArea').value || '';
  if (!ch || !KEYMAP[ch]) {
    alert('Choose a valid channel');
    return;
  }
  const r = encode(ch, d, txt);
  $('outputBox').textContent = r.out;
  updateCoverage();
  $('tokens').textContent = `${r.tokens.length} / ${r.out.length}`;
  $('speed').textContent = `${Math.round(r.elapsed)}ms`;
  $('entropy').textContent = estimateEntropy(r.out).toFixed(2);
});

$('decodeBtn').addEventListener('click', () => {
  const ch = $('channelSelect').value;
  const d = $('delimiter').value || ' ';
  const tok = $('outputBox').textContent || '';
  const r = decode(ch, d, tok);
  $('inputArea').value = r.text;
  updateCoverage();
  $('tokens').textContent = `${r.toks.length} / ${tok.length}`;
  $('speed').textContent = `${Math.round(r.elapsed)}ms`;
  $('entropy').textContent = estimateEntropy(tok).toFixed(2);
});

$('copyBtn').addEventListener('click', async () => {
  const txt = $('outputBox').textContent || '';
  if (!txt) return;
  try {
    await navigator.clipboard.writeText(txt);
  } catch (e) { }
});

loadKey();
</script>
</body>
</html>
