<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Multi‑Channel Encoder / Decoder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--maxw:820px;--accent:#0366d6}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px auto;padding:20px;max-width:var(--maxw);color:#111}
    label{display:block;margin:8px 0 6px;font-weight:600}
    input,textarea,button{font:inherit}
    input,textarea{width:100%;padding:8px;border:1px solid #dcdcdc;border-radius:6px;box-sizing:border-box}
    textarea{min-height:110px;resize:vertical}
    button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .muted{color:#666;font-size:13px}
    #output{white-space:pre-wrap;background:#fafafa;padding:12px;border:1px solid #eee;border-radius:6px;min-height:64px}
    #channelButtons{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .channel-btn{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer;font-weight:600}
    .channel-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    @media (max-width:520px){ .controls{flex-direction:column} }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen">
    <h2>Site Login</h2>
    <label for="siteUser">Username</label>
    <input id="siteUser" type="text" placeholder="Enter username (e.g. jai)" autocomplete="username" />
    <label for="sitePassword">Site password</label>
    <input id="sitePassword" type="password" placeholder="Enter site password" autocomplete="current-password" />
    <div style="margin-top:12px">
      <button id="enterBtn" class="primary">Enter</button>
      <button id="guestBtn">Enter as Guest</button>
    </div>
    <div id="loginError" class="muted" style="margin-top:10px"></div>
    <hr style="margin:18px 0" />
    <div class="muted">Site password is <strong>letmein</strong>. Admin username is <strong>jai</strong>.</div>
  </div>

  <!-- APP -->
  <div id="mainApp" style="display:none">
    <h1>Multi‑Channel Encoder / Decoder</h1>
    <label for="password">Re‑type username to decode</label>
    <input id="password" type="text" placeholder="Re‑type your username here before clicking Decode" autocomplete="off" />
    <label>Channels</label>
    <div id="channelButtons" aria-label="Channels"></div>
    <label for="inputText">Input (text to encode or codes to decode)</label>
    <textarea id="inputText" placeholder="Type plain text to encode or numbers (space separated) to decode"></textarea>
    <div class="controls" style="margin-bottom:12px">
      <button id="encodeBtn">Encode</button>
      <button id="decodeBtn" class="primary">Decode</button>
    </div>
    <h3>Result:</h3>
    <div id="output">Key not loaded yet.</div>
  </div>

  <script>
    // CONFIG
    const SITE_PASSWORD = "letmein";
    const USER_LIST = { jai: "Jai", declan: "Declan", xander: "Xander", xavier: "Xavier", tanis: "Tanis" };

    // STATE
    let keybook = {};
    let currentChannel = "";

    // HELPERS
    const $ = id => document.getElementById(id);
    const setOut = txt => { if($('output')) $('output').innerText = txt; };
    function hasMap(ch) { return keybook && keybook[ch] && typeof keybook[ch] === "object" && Object.keys(keybook[ch]).length > 0; }
    function sessionUser() { return sessionStorage.getItem("siteUser") || ""; }

    // RENDER CHANNEL BUTTONS
    function renderChannelButtons(){
      const container = $('channelButtons');
      container.innerHTML = "";
      const channels = Object.keys(keybook || {});
      if(!channels.length){ container.innerHTML = '<div class="muted">No channels found in key.json</div>'; return; }
      channels.forEach((ch, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'channel-btn';
        btn.dataset.channel = ch;
        btn.innerText = ch;
        if(!currentChannel && idx === 0) currentChannel = ch;
        if(currentChannel === ch) btn.classList.add('active');
        btn.addEventListener('click', () => {
          Array.from(container.children).forEach(c => c.classList && c.classList.remove('active'));
          btn.classList.add('active');
          currentChannel = ch;
          setOut("Channel selected: " + currentChannel);
        });
        container.appendChild(btn);
      });
    }

    // LOAD KEY
    async function loadKey(){
      try {
        const r = await fetch('key.json', { cache: 'no-store' });
        if(!r.ok) throw new Error('key.json fetch failed: ' + r.status);
        keybook = await r.json();
        renderChannelButtons();
        setOut("Key loaded. Ready to encode or decode.");
      } catch (err) {
        console.error(err);
        setOut("Failed to load key.json.");
      }
    }

    // ENCODE
    function encode(){
      if(!currentChannel || !hasMap(currentChannel)){ setOut("No mapping for selected channel."); return; }
      const input = ($('inputText').value || '');
      const map = keybook[currentChannel];
      const out = [...input].map(ch => { const k = ch.toUpperCase(); return map[k] !== undefined ? String(map[k]) : '?'; }).join(' ');
      setOut(out || "[empty]");
    }

    // DECODE
    function decode(){
      if(!currentChannel || !hasMap(currentChannel)){ setOut("No mapping for selected channel."); return; }
      const entered = (($('password').value || '').toLowerCase().trim());
      const logged = sessionUser().toLowerCase();
      if(!logged || logged !== entered){
        setOut("Invalid user. Cannot decode.");
        return;
      }
      const forward = keybook[currentChannel];
      const reverse = {};
      for(const [k,v] of Object.entries(forward)) reverse[String(v)] = k;
      const tokens = ($('inputText').value || '').trim().split(/\s+/).filter(Boolean);
      const decoded = tokens.map(t => reverse[t] || '?').join('');
      const displayName = USER_LIST[logged] || logged;
      setOut(`Welcome, ${displayName}!\n\n${decoded || "[empty]"}`);
    }

    // EVENTS
    document.addEventListener('DOMContentLoaded', () => {
      $('enterBtn').addEventListener('click', async () => {
        const user = (($('siteUser').value || '').toLowerCase().trim());
        const pwd  = (($('sitePassword').value || '').trim());
        if(!user){ $('loginError').innerText = "Enter a username."; return; }
        if(pwd !== SITE_PASSWORD){ $('loginError').innerText = "Incorrect site password."; return; }
        sessionStorage.setItem('siteUser', user);
        $('loginError').innerText = "";
        $('loginScreen').style.display = 'none';
        $('mainApp').style.display = 'block';
        await loadKey();
      });

      $('guestBtn').addEventListener('click', () => {
        sessionStorage.removeItem('siteUser');
        $('loginError').innerText = "Guest mode: decoding requires username match.";
        $('loginScreen').style.display = 'none';
        $('mainApp').style.display = 'block';
        loadKey();
      });

      $('encodeBtn').addEventListener('click', encode);
      $('decodeBtn').addEventListener('click', decode);
    });
  </script>
</body>
</html>
