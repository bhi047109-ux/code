<!doctype html>
<!--
  index.html â€” Encoder/Decoder Console (single-file)

  Expected nearby files (place in same folder as this index.html on GitHub Pages or static host):

  1) key.json
     Shape: a map of channelName -> mapping object (char -> token)
     Example:
     {
       "alpha": { "A":"01", "B":"02", "C":"03", " ":"00", ",":"2C" },
       "numeric": { "0":"30", "1":"31", "2":"32", " ":"00" }
     }

     - The mapping is used for Encode: each character maps to a token string.
     - Decode will reverse-map tokens back to characters; tokens are separated by the delimiter input.

  2) lockdown.json
     Shape:
     {
       "active": false,
       "title": "ðŸš¨ SYSTEM LOCKDOWN ðŸš¨",
       "message": "Access denied until lockdown is lifted",
       "refreshSeconds": 120
     }

     - If active === true the app shows a full-screen lockdown animation and blocks the UI.
     - The page will re-fetch lockdown.json periodically according to refreshSeconds.

  NOTES:
  - This file is standalone. It uses only vanilla JS (no external libraries).
  - For classroom use: host index.html plus key.json and lockdown.json together.
  - For security: this is a client-side tool with mappings and secrets exposed if stored client-side.
-->

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encoder/Decoder Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ---- Theme variables ---- */
    :root{
      --bg: #071017;
      --panel: linear-gradient(180deg,#071017cc,#0b1620cc);
      --muted: #9fb4bc;
      --fg: #e8f6f7;
      --accent: #39d1ff;
      --accent-2: #8a5cff;
      --danger: #ff4d6d;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
    }
    body.light {
      --bg: #f6f9fb;
      --panel: linear-gradient(180deg,#ffffff,#f2f6f9);
      --muted: #51646f;
      --fg: #042028;
      --accent: #0b84ff;
      --accent-2: #8a5cff;
      --glass: rgba(2,6,23,0.02);
      --glass-2: rgba(2,6,23,0.01);
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#030406);color:var(--fg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    #matrix { position:fixed; inset:0; z-index:0; pointer-events:none; opacity:0; transition:opacity .5s ease-in-out; }
    #matrix.active { opacity:0.9; }

    .container { position:relative; z-index:2; max-width:1200px; margin:20px auto; padding:18px; border-radius:12px; background:var(--panel); box-shadow: 0 8px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03); }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .title { display:flex; gap:12px; align-items:center; }
    h1{margin:0;font-size:20px}
    .hint { color:var(--muted); font-size:13px; }

    /* start gate */
    .startgate { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,rgba(0,0,0,0.65),rgba(0,0,0,0.85)); z-index:10000; }
    .gateBox { width:360px; max-width:94%; background:rgba(255,255,255,0.02); border-radius:12px; padding:18px; text-align:center; border:1px solid rgba(255,255,255,0.03); box-shadow:0 12px 40px rgba(0,0,0,0.6); }
    .gateBox h2{margin:0;color:var(--accent);font-size:18px}
    .gateBox p{color:var(--muted);margin:10px 0 12px}
    .gateBox input{font-size:20px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);width:100%;text-align:center;background:transparent;color:var(--fg)}
    .gateBox button{margin-top:12px;padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#021217;cursor:pointer;font-weight:700}

    /* lockdown full-screen */
    .lockdown { position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; text-align:center; background: radial-gradient(circle at 30% 20%, rgba(138,92,255,0.12), rgba(0,0,0,0.9)), linear-gradient(180deg,#0b0b12,#050406); color:#fff; overflow:hidden; }
    .lockdown.active { display:flex; }
    .lockcard { max-width:900px; padding:26px; border-radius:12px; background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); }
    .lockcard h2 { color:var(--accent-2); margin:0 0 6px; }
    .lockcard p { color:#f7f7f7; margin:0 0 14px; font-size:16px; }
    .siren { width:20px;height:20px;border-radius:50%;background:var(--danger);box-shadow:0 0 12px var(--danger),0 0 34px rgba(255,56,96,0.12); animation: pulse 1200ms infinite; display:inline-block; vertical-align:middle; margin-right:8px; }
    @keyframes pulse { 0% { transform:scale(1); opacity:1 } 50% { transform:scale(1.4); opacity:0.7 } 100% { transform:scale(1); opacity:1 } }

    /* layout */
    .row { display:flex; gap:12px; align-items:flex-start; }
    .col { flex:1; min-width:0; }
    .panel { background:rgba(255,255,255,0.02); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    label { display:block; color:var(--muted); font-size:13px; margin-bottom:6px; }
    select,input[type=text],textarea { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--fg); resize:vertical; font-size:14px; box-sizing:border-box;}
    textarea { min-height:140px; max-height:360px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn { padding:8px 12px; border-radius:8px; border:none; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#021217; cursor:pointer; font-weight:700; }
    .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--fg) }
    .btn.warn { background:linear-gradient(180deg,var(--danger),#a01f3a); color:#fff }
    .small { font-size:13px; color:var(--muted); }

    .history { max-height:320px; overflow:auto; padding:6px; display:flex; flex-direction:column; gap:8px; }
    .hrow { display:flex; gap:8px; align-items:flex-start; background:rgba(255,255,255,0.01); padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }
    .htime { color:var(--muted); min-width:130px; font-size:12px; }
    .htext { flex:1; font-family:monospace; font-size:13px; color:var(--fg); white-space:pre-wrap; word-break:break-word; }

    .status { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:13px; }
    .status .pill { background:rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }

    .glitch { position:relative; color:var(--accent-2); text-shadow:0 0 6px rgba(138,92,255,0.5); }
    .glitch::after, .glitch::before { content: attr(data-text); position:absolute; left:0; top:0; width:100%; opacity:0.6; mix-blend-mode:screen; }
    .glitch::before { color:#39d1ff; transform:translate(2px,-1px); clip-path: inset(0 0 60% 0); }
    .glitch::after { color:#ff6fb5; transform:translate(-2px,1px); clip-path: inset(40% 0 0 0); }

    @media (max-width:960px){
      .row { flex-direction:column; }
      header { flex-direction:column; align-items:flex-start }
    }

    button:focus, input:focus, textarea:focus, select:focus { outline: 2px solid rgba(57,209,255,0.14); outline-offset:2px; }

    footer { margin-top:12px; color:var(--muted); font-size:12px; text-align:center; }
  </style>
</head>
<body>
  <canvas id="matrix" aria-hidden="true"></canvas>

  <!-- Lockdown overlay (controlled by lockdown.json) -->
  <div id="lockdown" class="lockdown" role="alert" aria-hidden="true">
    <div class="lockcard" role="document" aria-live="assertive">
      <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px">
        <div class="siren" id="sirenLight" style="display:none"></div>
        <h2 id="lockTitle">SYSTEM LOCKDOWN</h2>
      </div>
      <p id="lockMessage">Access denied until lockdown is lifted</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button class="btn" id="shakeLock">Shake Lockdown</button>
        <button class="btn ghost" id="refreshLock">Refresh</button>
      </div>
    </div>
  </div>

  <!-- Start gate modal (requires code 1234) -->
  <div id="startGate" class="startgate" role="dialog" aria-modal="true" aria-hidden="false">
    <div class="gateBox" role="document" aria-label="Start gate">
      <h2>Enter 4â€‘digit code to start</h2>
      <p>Type the 4-digit code to unlock the console</p>
      <input id="gateInput" inputmode="numeric" maxlength="4" placeholder="----" aria-label="Start code" />
      <button id="gateOpen">Open</button>
      <p style="margin-top:8px;color:var(--muted);font-size:13px">Start gate blocks the page until the correct code is entered.</p>
    </div>
  </div>

  <div class="container" id="app" aria-hidden="true">
    <header>
      <div class="title">
        <h1>Encoder / Decoder Console</h1>
        <div class="hint">Static client-side tool â€¢ loads key.json & lockdown.json</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div id="profileStatus" class="small">Ready</div>
        <button class="btn ghost" id="toggleTheme" title="Toggle theme">Theme</button>
        <button class="btn ghost" id="toggleMatrix" title="Toggle Matrix Rain">Matrix</button>
        <button class="btn ghost" id="toggleGlitch" title="Toggle Glitch">Glitch</button>
        <button class="btn ghost" id="sirenToggle" title="Toggle Siren">Siren</button>
      </div>
    </header>

    <main>
      <div class="row">
        <div class="col panel" style="z-index:2">
          <label for="channelSelect">Channel</label>
          <select id="channelSelect" aria-label="Channel selector"><option>Loading key.json...</option></select>

          <label for="delimiter" style="margin-top:10px">Delimiter</label>
          <input id="delimiter" type="text" value=" " placeholder="Delimiter between tokens" aria-label="Delimiter" />

          <label for="inputArea" style="margin-top:10px">Input</label>
          <textarea id="inputArea" placeholder="Type or paste text to encode/decode..." aria-label="Input area"></textarea>

          <div class="controls" style="margin-top:8px">
            <button class="btn" id="encodeBtn">Encode</button>
            <button class="btn" id="decodeBtn">Decode</button>
            <button class="btn ghost" id="copyBtn">Copy Output</button>
            <button class="btn ghost" id="scrambleBtn">Scramble Output</button>
            <button class="btn ghost" id="randomBtn">Random Test</button>
            <button class="btn ghost" id="exportBtn">Export History</button>
            <button class="btn ghost" id="shakeBtn">Shake Lockdown</button>
          </div>

          <div class="status" aria-live="polite">
            <div class="pill">Coverage: <span id="coverage">-</span></div>
            <div class="pill">Tokens/Len: <span id="tokens">-</span></div>
            <div class="pill">Speed: <span id="speed">-</span></div>
            <div class="pill">Entropy: <span id="entropy">-</span></div>
          </div>
        </div>

        <div class="col panel" style="z-index:2;max-width:520px;min-width:260px">
          <label>Output</label>
          <pre id="outputBox" aria-live="polite" class="small" style="min-height:160px; white-space:pre-wrap"></pre>

          <div style="margin-top:8px" class="small">History</div>
          <div class="history" id="historyPanel" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <footer class="small">Encoder Console â€¢ Single file app â€¢ No external libraries</footer>
  </div>

<script>
/* ========= App JavaScript =========
   - Loads key.json and lockdown.json
   - Start gate requiring code 1234
   - Encode/Decode with per-channel mappings
   - Scramble, Random Test, Copy, Export History, Matrix, Glitch, Siren, Shake
   - Profiling and entropy estimate
*/

/* Helpers */
const $ = id => document.getElementById(id);
const now = () => performance.now();
const isoNow = () => new Date().toISOString();

function hexOfChar(ch){
  const u = new TextEncoder().encode(ch);
  return Array.from(u).map(b => b.toString(16).padStart(2,'0')).join('');
}
function charFromHex(hex){
  if (!hex) return '';
  const bytes = hex.match(/.{1,2}/g);
  if (!bytes) return '?';
  try {
    return new TextDecoder().decode(new Uint8Array(bytes.map(h => parseInt(h,16))));
  } catch(e){
    return '?';
  }
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function downloadFile(filename, content, type='application/json'){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

/* State */
let KEYMAP = {};
let LOCKCFG = { active:false, title:'', message:'', refreshSeconds:120 };
let HISTORY = [];
let matrixOn = false, matrixAnim = null;
let glitchOn = false;
let themeLight = false;
let sirenOn = false;
let lockdownInterval = null;

/* DOM refs */
const startGate = $('startGate');
const gateInput = $('gateInput');
const gateOpen = $('gateOpen');
const app = $('app');
const channelSelect = $('channelSelect');
const delimiter = $('delimiter');
const inputArea = $('inputArea');
const encodeBtn = $('encodeBtn');
const decodeBtn = $('decodeBtn');
const outputBox = $('outputBox');
const copyBtn = $('copyBtn');
const scrambleBtn = $('scrambleBtn');
const randomBtn = $('randomBtn');
const exportBtn = $('exportBtn');
const historyPanel = $('historyPanel');
const coverage = $('coverage');
const tokens = $('tokens');
const speed = $('speed');
const entropy = $('entropy');
const toggleTheme = $('toggleTheme');
const toggleMatrix = $('toggleMatrix');
const toggleGlitch = $('toggleGlitch');
const sirenToggle = $('sirenToggle');
const shakeBtn = $('shakeBtn');
const lockdownEl = $('lockdown');
const lockTitle = $('lockTitle');
const lockMessage = $('lockMessage');
const sirenLight = $('sirenLight');
const matrixCanvas = $('matrix');
const shakeLock = $('shakeLock');
const refreshLock = $('refreshLock');
const profileStatus = $('profileStatus');

/* Start gate */
function openApp(){ startGate.style.display='none'; startGate.setAttribute('aria-hidden','true'); app.setAttribute('aria-hidden','false'); app.style.opacity=1; }
gateOpen.addEventListener('click', () => {
  const v = (gateInput.value||'').trim();
  if (v === '1234') openApp(); else { gateInput.value=''; gateInput.focus(); alert('Incorrect code'); }
});
gateInput.addEventListener('keyup', e => { if (e.key === 'Enter') gateOpen.click(); });

/* Load key.json */
async function loadKeyJson(){
  try{
    const r = await fetch('key.json', {cache:'no-store'});
    if (!r.ok) throw new Error('key.json not found');
    KEYMAP = await r.json();
    populateChannels();
    profileStatus.textContent = 'Loaded key.json';
  }catch(e){
    KEYMAP = {};
    channelSelect.innerHTML = '<option>(no key.json)</option>';
    profileStatus.textContent = 'No key.json';
    console.warn('loadKeyJson', e);
  }
}
function populateChannels(){
  channelSelect.innerHTML = '';
  const names = Object.keys(KEYMAP).sort();
  if (names.length === 0){ const opt=document.createElement('option'); opt.textContent='(no channels)'; channelSelect.appendChild(opt); return; }
  for(const n of names){ const opt=document.createElement('option'); opt.value=n; opt.textContent=n; channelSelect.appendChild(opt); }
}

/* Load lockdown.json */
async function loadLockdownJson(){
  try{
    const r = await fetch('lockdown.json', {cache:'no-store'});
    if (!r.ok) throw new Error('lockdown.json not found');
    const cfg = await r.json();
    LOCKCFG = Object.assign({active:false,title:'',message:'',refreshSeconds:120}, cfg);
    applyLockdown();
    if (lockdownInterval) clearInterval(lockdownInterval);
    lockdownInterval = setInterval(loadLockdownJson, (LOCKCFG.refreshSeconds||120)*1000);
  }catch(e){
    LOCKCFG = {active:false,title:'',message:'',refreshSeconds:120};
    applyLockdown();
  }
}
function applyLockdown(){
  if (LOCKCFG.active){
    lockdownEl.classList.add('active'); lockdownEl.setAttribute('aria-hidden','false');
    lockTitle.textContent = LOCKCFG.title || 'SYSTEM LOCKDOWN';
    lockMessage.textContent = LOCKCFG.message || 'Access denied until lockdown is lifted';
    app.style.filter = 'blur(3px) grayscale(.2)';
    profileStatus.textContent = 'LOCKDOWN ACTIVE';
    sirenOn = true; updateSiren();
  } else {
    lockdownEl.classList.remove('active'); lockdownEl.setAttribute('aria-hidden','true');
    app.style.filter = '';
    profileStatus.textContent = 'Ready';
    sirenOn = false; updateSiren();
  }
}

/* Encode / Decode */
function coveragePct(channel){
  const map = KEYMAP[channel] || {};
  const count = Object.keys(map).length;
  return Math.round((count/256)*100);
}
function encode(channel, delim, text){
  const t0 = now();
  const map = KEYMAP[channel] || {};
  const tokensOut = [];
  for(const ch of Array.from(text)){
    if (Object.prototype.hasOwnProperty.call(map, ch)) tokensOut.push(map[ch]);
    else tokensOut.push(`${channel}_UNK_${hexOfChar(ch)}`);
  }
  const out = tokensOut.join(delim);
  const elapsed = now() - t0;
  return { out, tokensOut, elapsed };
}
function decode(channel, delim, tokenText){
  const t0 = now();
  const map = KEYMAP[channel] || {};
  const rev = {};
  for(const k in map) rev[map[k]] = k;
  const toks = tokenText.length ? tokenText.split(delim) : [];
  const chars = [];
  for(const tk of toks){
    if (tk.startsWith(channel + '_UNK_')){
      const hx = tk.substring((channel + '_UNK_').length);
      try{ chars.push(charFromHex(hx)); } catch(e){ chars.push('?'); }
    } else if (rev[tk] !== undefined){
      chars.push(rev[tk]);
    } else {
      chars.push('?');
    }
  }
  const text = chars.join('');
  const elapsed = now() - t0;
  return { text, toks, elapsed };
}

/* UI wiring */
encodeBtn.addEventListener('click', async ()=>{
  const ch = channelSelect.value;
  const delim = delimiter.value || ' ';
  const text = inputArea.value || '';
  if (!ch || !KEYMAP[ch]) { alert('Choose a valid channel'); return; }
  const t0 = now();
  const res = encode(ch, delim, text);
  const t1 = now() - t0;
  outputBox.textContent = res.out;
  coverage.textContent = coveragePct(ch) + '%';
  tokens.textContent = `${res.tokensOut.length} / ${res.out.length}`;
  speed.textContent = `${Math.round(t1)}ms`;
  entropy.textContent = estimateEntropy(res.out).toFixed(2);
  HISTORY.unshift({ ts: isoNow(), action:'encode', channel:ch, input:text, output:res.out, ms: Math.round(t1) });
  renderHistory();
  applyGlitch();
});

decodeBtn.addEventListener('click', async ()=>{
  const ch = channelSelect.value;
  const delim = delimiter.value || ' ';
  const tokenText = outputBox.textContent || '';
  if (!ch || !KEYMAP[ch]) { alert('Choose a valid channel'); return; }
  const t0 = now();
  const res = decode(ch, delim, tokenText);
  const t1 = now() - t0;
  inputArea.value = res.text;
  coverage.textContent = coveragePct(ch) + '%';
  tokens.textContent = `${res.toks.length} / ${tokenText.length}`;
  speed.textContent = `${Math.round(t1)}ms`;
  entropy.textContent = estimateEntropy(tokenText).toFixed(2);
  HISTORY.unshift({ ts: isoNow(), action:'decode', channel:ch, tokens:res.toks.length, outputText:res.text, ms: Math.round(t1) });
  renderHistory();
  applyGlitch();
});

copyBtn.addEventListener('click', async ()=>{
  const txt = outputBox.textContent || '';
  if (!txt) return;
  try {
    await navigator.clipboard.writeText(txt);
    profileStatus.textContent = 'Copied to clipboard';
  } catch(e){
    profileStatus.textContent = 'Copy failed';
  }
});

scrambleBtn.addEventListener('click', ()=>{
  const delim = delimiter.value || ' ';
  const txt = outputBox.textContent || '';
  if (!txt) return;
  const toks = txt.split(delim);
  const shuffled = shuffle(toks.slice()).join(delim);
  outputBox.textContent = shuffled;
  HISTORY.unshift({ ts: isoNow(), action:'scramble', tokens:toks.length });
  renderHistory();
});

randomBtn.addEventListener('click', ()=>{
  const samples = ['hello world','secret code','play time','box hill lab','RJ45-A2','the quick brown fox','lorem ipsum dolor sit amet','TEST123','ðŸ˜€ smile'];
  inputArea.value = samples[Math.floor(Math.random()*samples.length)];
});

exportBtn.addEventListener('click', ()=>{
  downloadFile(`history_${new Date().toISOString().replace(/[:.]/g,'-')}.json`, JSON.stringify(HISTORY, null, 2));
});

$('toggleTheme').addEventListener('click', ()=>{
  themeLight = !themeLight;
  document.body.classList.toggle('light', themeLight);
});

$('toggleGlitch').addEventListener('click', ()=>{
  glitchOn = !glitchOn;
  applyGlitch();
});

$('toggleMatrix').addEventListener('click', ()=>{
  if (!matrixOn) startMatrix(); else stopMatrix();
});

$('sirenToggle').addEventListener('click', ()=>{
  sirenOn = !sirenOn; updateSiren();
});

$('shakeBtn').addEventListener('click', doShake);
$('shakeLock').addEventListener('click', doShake);
$('refreshLock').addEventListener('click', loadLockdownJson);

/* History render */
function renderHistory(){
  historyPanel.innerHTML = '';
  for(const h of HISTORY.slice(0,200)){
    const row = document.createElement('div'); row.className = 'hrow';
    const t = document.createElement('div'); t.className = 'htime'; t.textContent = new Date(h.ts).toLocaleString();
    const txt = document.createElement('div'); txt.className='htext';
    let summary = h.action.toUpperCase();
    if (h.channel) summary += ' â€¢ ' + h.channel;
    if (h.input) summary += ' â€¢ ' + (h.input.length>80 ? h.input.slice(0,77)+'â€¦' : h.input);
    txt.textContent = summary;
    row.appendChild(t); row.appendChild(txt); historyPanel.appendChild(row);
  }
}

/* Glitch effect */
function applyGlitch(){
  if (glitchOn){
    outputBox.classList.add('glitch'); outputBox.setAttribute('data-text', outputBox.textContent);
    outputBox.animate([{opacity:1},{opacity:0.7},{opacity:1}], {duration:400, iterations:1});
  } else {
    outputBox.classList.remove('glitch'); outputBox.removeAttribute('data-text');
  }
}

/* Siren sound and light */
function updateSiren(){
  if (sirenOn){
    sirenLight.style.display = 'inline-block';
    trySiren(true);
  } else {
    sirenLight.style.display = 'none';
    trySiren(false);
  }
}
let audioCtx = null, osc = null, oscTimer = null;
function trySiren(on){
  try{
    if (!on){ if (osc){ try{ osc.stop(); }catch(e){} osc=null; } return; }
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;
    audioCtx = audioCtx || new AudioCtx();
    osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    gain.gain.value = 0.02;
    osc.type = 'sine';
    osc.frequency.value = 600;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
    oscTimer = setInterval(()=>{
      if (!osc) return;
      const f = 600 + 220*Math.sin(Date.now()/200);
      try{ osc.frequency.setValueAtTime(f, audioCtx.currentTime); }catch(e){}
    }, 80);
    setTimeout(()=>{ try{ if (osc) osc.stop(); osc=null; clearInterval(oscTimer); }catch(e){} }, 10000);
  }catch(e){}
}

/* Shake UI */
function doShake(){
  const el = document.querySelector('.container');
  el.animate([
    { transform: 'translateX(0) rotate(0)' },
    { transform: 'translateX(-10px) rotate(-1deg)' },
    { transform: 'translateX(10px) rotate(1deg)' },
    { transform: 'translateX(-8px) rotate(-1deg)' },
    { transform: 'translateX(8px) rotate(1deg)' },
    { transform: 'translateX(0) rotate(0)' }
  ], { duration: 700, easing: 'ease-in-out' });
}

/* Matrix rain background */
const MC = matrixCanvas;
let matCtx=null, cols=0, fontSize=16, drops=[];
function startMatrix(){
  MC.classList.add('active'); matrixOn=true;
  MC.width = window.innerWidth; MC.height = window.innerHeight;
  matCtx = MC.getContext('2d');
  fontSize = 16;
  cols = Math.floor(MC.width / fontSize);
  drops = Array.from({length:cols}, ()=>1);
  function draw(){
    if (!matrixOn) return;
    matCtx.fillStyle = 'rgba(0,0,0,0.12)';
    matCtx.fillRect(0,0,MC.width,MC.height);
    matCtx.font = fontSize + 'px monospace';
    for(let i=0;i<cols;i++){
      const text = String.fromCharCode(33 + Math.random()*94);
      matCtx.fillStyle = `rgba(57,255,140,${0.2 + Math.random()*0.8})`;
      matCtx.fillText(text, i*fontSize, drops[i]*fontSize);
      if (drops[i]*fontSize > MC.height && Math.random() > 0.975) drops[i]=0;
      drops[i]++;
    }
    matrixAnim = requestAnimationFrame(draw);
  }
  draw();
}
function stopMatrix(){
  MC.classList.remove('active'); matrixOn=false;
  if (matrixAnim) cancelAnimationFrame(matrixAnim);
  if (matCtx) matCtx.clearRect(0,0,MC.width,MC.height);
}

/* Simple entropy estimate */
function estimateEntropy(s){
  if (!s) return 0;
  const freq = {};
  for(const c of s) freq[c] = (freq[c]||0)+1;
  let H = 0; const L = s.length;
  for(const k in freq){ const p = freq[k]/L; H -= p * Math.log2(p); }
  return H;
}

/* Initialization */
async function init(){
  app.setAttribute('aria-hidden','true');
  app.style.opacity = 0;
  await loadKeyJson();
  await loadLockdownJson();
  delimiter.value = delimiter.value || ' ';
  channelSelect.addEventListener('change', ()=> profileStatus.textContent = `Channel: ${channelSelect.value}`);
  window.addEventListener('resize', ()=> { if (matrixOn){ MC.width = window.innerWidth; MC.height = window.innerHeight; } });
}
init();

/* Keyboard: Enter on start gate opens */
gateInput.addEventListener('input', () => { gateInput.value = gateInput.value.replace(/[^\d]/g,'').slice(0,4); });
setTimeout(()=> gateInput.focus(), 200);

/* Toggle lockdown with Ctrl+Shift+L for testing */
document.addEventListener('keydown', (e)=>{
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l'){ LOCKCFG.active = !LOCKCFG.active; applyLockdown(); }
});

</script>
</body>
</html>

