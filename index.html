<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secure Decoder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:,">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:20px;max-width:640px;margin:auto}
    textarea,input,select{width:100%;margin-bottom:10px;font-size:16px;padding:6px}
    button{margin-right:10px;padding:8px 16px;font-size:16px}
    #output{white-space:pre-wrap;background:#f0f0f0;padding:10px;font-size:16px;min-height:64px}
    #adminPanel{display:none;margin-top:20px;padding:10px;border:1px solid #ccc;background:#f9f9f9}
    #shutter{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;
      background:repeating-linear-gradient(90deg,#222 0,#333 10px,#222 20px);color:#fff;font-size:24px;z-index:9999}
    #sorryBtn{margin-top:20px;padding:10px 20px;font-size:20px;background:crimson;color:#fff;border:0;cursor:pointer}
  </style>
</head>
<body>
  <div id="loginScreen">
    <h2>Enter Access Password</h2>
    <input type="password" id="sitePassword" placeholder="Site password" />
    <button id="enterBtn">Enter</button>
    <div id="loginError" style="color:red;margin-top:10px"></div>
  </div>

  <div id="mainApp" style="display:none">
    <h1>Multi-Channel Encoder/Decoder</h1>

    <input type="password" id="password" placeholder="Enter user password" />
    <select id="channelSelect">
      <option value="ch1">Channel 1</option>
      <option value="ch2">Channel 2</option>
      <option value="ch3">Channel 3</option>
    </select>

    <textarea id="inputText" placeholder="Enter text or encoded numbers here"></textarea>
    <div>
      <button id="encodeBtn">Encode</button>
      <button id="decodeBtn">Decode</button>
      <button id="alertBtn">Teacher Saw It</button>
    </div>

    <h3>Result:</h3>
    <div id="output">Loading key...</div>

    <div id="adminPanel">
      <h3>Admin panel</h3>
      <button id="toggleLockBtn">Toggle Lock</button>
      <div id="lockStatus" style="margin-top:8px"></div>
    </div>

    <div id="shutter">
      <div>ðŸ”’ Decoder Locked â€” Unauthorized access detected.</div>
      <button id="sorryBtn">SORRY</button>
    </div>
  </div>

<script>
  // Config
  const siteAccessPassword = "letmein";
  const validPasswords = {
    jai: "Jai",
    declan: "Declan",
    xander: "Xander",
    xavier: "Xavier",
    tanis: "Tanis"
  };
  const API = "https://code-9v3r.onrender.com"; // backend host (Render)
  // State
  let keybook = {};
  let currentChannel = "ch1";
  let reverseMap = {};
  let isLocked = false;
  let sorryClicks = 0;

  // Helpers
  function hasValidMapFor(channel) {
    return keybook && keybook[channel] && typeof keybook[channel] === "object" && Object.keys(keybook[channel]).length>0;
  }

  async function checkSitePassword() {
    const entered = (document.getElementById("sitePassword").value || "").trim();
    if (entered === siteAccessPassword) {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      await loadKey();
    } else {
      document.getElementById("loginError").innerText = "Incorrect password.";
    }
  }

  async function checkLock() {
    try {
      const res = await fetch(API + "/lock.json", {cache:"no-store"});
      const data = await res.json();
      isLocked = !!data.locked;
      document.getElementById("shutter").style.display = isLocked ? "flex" : "none";
      document.getElementById("encodeBtn").disabled = isLocked;
      document.getElementById("decodeBtn").disabled = isLocked;
      const ls = document.getElementById("lockStatus");
      if (ls) ls.innerText = isLocked ? "ðŸ”’ Site is locked." : "ðŸ”“ Site is unlocked.";
    } catch (e) {
      document.getElementById("output").innerText = "Error checking lock state.";
    }
  }

  async function loadKey() {
    await checkLock();
    if (isLocked) return;
    try {
      const res = await fetch("key.json", {cache:"no-store"});
      keybook = await res.json();
      // ensure channelSelect reflects available channels
      const sel = document.getElementById("channelSelect");
      const channels = Object.keys(keybook || {});
      if (channels.length) {
        // if current channel not found, switch to first
        if (!channels.includes(currentChannel)) currentChannel = channels[0];
        // replace select options if they differ (keeps UI in sync)
        // only replace if set doesn't match
        const opts = Array.from(sel.options).map(o=>o.value);
        if (JSON.stringify(opts)!==JSON.stringify(channels.slice(0,opts.length))) {
          sel.innerHTML = channels.map(c=>`<option value="${c}">${c}</option>`).join("");
          sel.value = currentChannel;
        }
      }
      document.getElementById("output").innerText = hasValidMapFor(currentChannel) ? "Key loaded. Ready." : "Key loaded but channel map empty.";
    } catch (e) {
      document.getElementById("output").innerText = "Failed to load key.json.";
    }
  }

  function buildReverseMap(channel) {
    reverseMap = {};
    const forward = keybook[channel] || {};
    for (const [k,v] of Object.entries(forward)) reverseMap[String(v)] = k;
  }

  function encode() {
    // use selected channel for encode
    currentChannel = document.getElementById("channelSelect").value;
    if (!hasValidMapFor(currentChannel)) {
      document.getElementById("output").innerText = "No mapping for selected channel. Load key or choose another channel.";
      return;
    }
    const map = keybook[currentChannel];
    const input = document.getElementById("inputText").value || "";
    const result = [...input].map(ch => {
      const K = ch.toUpperCase();
      return map[K] !== undefined ? map[K] : "?";
    }).join(" ");
    document.getElementById("output").innerText = result.trim();
  }

  function decode() {
    if (!hasValidMapFor(document.getElementById("channelSelect").value)) {
      document.getElementById("output").innerText = "No mapping for selected channel. Load key or choose another channel.";
      return;
    }
    const enteredPassword = (document.getElementById("password").value || "").toLowerCase().trim();
    const selectedChannel = document.getElementById("channelSelect").value;
    if (!(enteredPassword in validPasswords)) {
      // invalid user â€” trigger lockdown
      document.getElementById("inputText").value = "";
      document.getElementById("password").value = "";
      document.getElementById("encodeBtn").disabled = true;
      document.getElementById("decodeBtn").disabled = true;
      document.getElementById("shutter").style.display = "flex";
      return;
    }
    // valid user, proceed
    buildReverseMap(selectedChannel);
    const input = (document.getElementById("inputText").value || "").trim();
    const result = input.split(/\s+/).map(tok => reverseMap[tok] || "?").join("");
    document.getElementById("output").innerText = `Welcome, ${validPasswords[enteredPassword]}!\n\n${result}`;

    // admin behavior for jai
    if (enteredPassword === "jai") {
      document.getElementById("adminPanel").style.display = "block";
      refreshAdminState();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }
  }

  async function refreshAdminState() {
    try {
      const res = await fetch(API + "/alert.json", {cache:"no-store"});
      const d = await res.json();
      if (d.alert) document.getElementById("lockStatus").innerText = "âš ï¸ ALERT: Teacher Saw It clicked.";
    } catch {}
  }

  // Buttons wiring
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("enterBtn").addEventListener("click", checkSitePassword);
    document.getElementById("encodeBtn").addEventListener("click", encode);
    document.getElementById("decodeBtn").addEventListener("click", decode);

    document.getElementById("alertBtn").addEventListener("click", async () => {
      try {
        await fetch(API + "/update-alert.php", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({alert:true})});
        document.getElementById("output").innerText = "âš ï¸ Alert sent.";
      } catch { document.getElementById("output").innerText = "Alert failed."; }
    });

    document.getElementById("toggleLockBtn").addEventListener("click", async () => {
      try {
        await fetch(API + "/update-lock.php", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({toggle:true})});
        await checkLock();
      } catch { document.getElementById("lockStatus").innerText = "Lock toggle failed."; }
    });

    document.getElementById("sorryBtn").addEventListener("click", () => {
      sorryClicks++;
      if (sorryClicks >= 10) {
        document.getElementById("shutter").style.display = "none";
        document.getElementById("encodeBtn").disabled = false;
        document.getElementById("decodeBtn").disabled = false;
        document.getElementById("output").innerText = "Decoder unlocked. Please enter a valid password.";
        sorryClicks = 0;
        document.getElementById("sorryBtn").innerText = "SORRY";
      } else {
        document.getElementById("sorryBtn").innerText = `SORRY (${sorryClicks})`;
      }
    });

    // initial quick load (if you want to load immediately)
    // loadKey(); // <-- only call after site password accepted
  });
</script>
</body>
</html>
