<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encoder / Decoder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Auto-refresh every 2 minutes -->
  <meta http-equiv="refresh" content="120">
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #111;
      color: #eee;
    }
    h1 { margin-bottom: 20px; }
    label { display:block; margin:8px 0 6px; font-weight:600 }
    input,textarea,button { font:inherit }
    input,textarea {
      width:100%; padding:8px; border:1px solid #dcdcdc;
      border-radius:6px; box-sizing:border-box
    }
    textarea { min-height:140px; resize:vertical }
    button {
      padding:8px 12px; border-radius:6px; border:1px solid #bbb;
      background:#fff; cursor:pointer
    }
    button.primary { background:#0366d6; color:#fff; border-color:#0366d6 }
    #output {
      white-space:pre-wrap; background:#fafafa; padding:12px;
      border:1px solid #eee; border-radius:6px; min-height:80px;
      color:#111;
    }
    .channel-btn {
      padding:8px 12px; border:1px solid #ccc; border-radius:8px;
      background:#fff; cursor:pointer; font-weight:600; margin:4px
    }
    .channel-btn.active {
      background:#0366d6; color:#fff; border-color:#0366d6
    }

    /* Lockdown animation */
    #lockdownScreen {
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      flex-direction:column;
      background: repeating-linear-gradient(
        45deg,
        #b00020,
        #b00020 20px,
        #111 20px,
        #111 40px
      );
      animation: flashbg 1s infinite;
    }
    .lockdown {
      font-size:3em;
      color:#fff;
      text-shadow:0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 40px #ff0000;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform:scale(1); opacity:1; }
      50% { transform:scale(1.2); opacity:0.6; }
      100% { transform:scale(1); opacity:1; }
    }
    @keyframes flashbg {
      0%,100% { filter:brightness(1); }
      50% { filter:brightness(0.6); }
    }
  </style>
</head>
<body>
  <div id="lockdownScreen" style="display:none">
    <h1 class="lockdown">ðŸš¨ SYSTEM LOCKDOWN ðŸš¨</h1>
    <p style="color:#fff;font-size:1.2em;">Access denied until lockdown is lifted</p>
  </div>

  <div id="mainApp" style="display:none; padding:20px;">
    <h1>Encoder / Decoder</h1>
    <label>Choose Channel</label>
    <div id="channelButtons"></div>

    <label for="delimiter">Delimiter</label>
    <input id="delimiter" type="text" value="|" style="width:100px" />

    <label for="inputText">Input (text to encode or codes to decode)</label>
    <textarea id="inputText"></textarea>

    <div style="margin:12px 0">
      <button id="encodeBtn">Encode</button>
      <button id="decodeBtn" class="primary">Decode</button>
    </div>

    <h3>Result:</h3>
    <div id="output">Key not loaded yet.</div>
  </div>

  <script>
    let keybook = {}, currentChannel = "";

    const $ = id => document.getElementById(id);
    const setOut = txt => { $('output').innerText = txt; };
    const delim = () => ($('delimiter').value || '|');

    function renderChannelButtons(){
      const container = $('channelButtons'); container.innerHTML="";
      const channels = Object.keys(keybook).filter(k => k !== "lockdown");
      channels.forEach((ch,idx)=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='channel-btn'; btn.innerText=ch;
        if(!currentChannel && idx===0) currentChannel=ch;
        if(currentChannel===ch) btn.classList.add('active');
        btn.onclick=()=>{ [...container.children].forEach(c=>c.classList.remove('active')); btn.classList.add('active'); currentChannel=ch; setOut("Channel selected: "+ch); };
        container.appendChild(btn);
      });
    }

    async function loadKey(){
      try{
        const r=await fetch('key.json',{cache:'no-store'});
        keybook=await r.json();
        if(keybook.lockdown){
          $('mainApp').style.display='none';
          $('lockdownScreen').style.display='flex';
          return;
        }
        $('lockdownScreen').style.display='none';
        $('mainApp').style.display='block';
        renderChannelButtons();
        setOut("Key loaded. Select a channel.");
      }
      catch(e){ setOut("Failed to load key.json."); }
    }

    function encode(){
      if(!currentChannel){ setOut("No channel selected."); return; }
      const map=keybook[currentChannel], input=$('inputText').value||'', d=delim();
      const out=[...input].map(ch=>map[ch]!==undefined?map[ch]:'?').join(d);
      setOut(out||"[empty]");
    }

    function decode(){
      if(!currentChannel){ setOut("No channel selected."); return; }
      const forward=keybook[currentChannel], reverse={};
      for(const [k,v] of Object.entries(forward)) reverse[v]=k;
      const tokens=($('inputText').value||'').split(delim()).filter(Boolean);
      const decoded=tokens.map(t=>reverse[t]||'?').join('');
      setOut(decoded||"[empty]");
    }

    document.addEventListener('DOMContentLoaded',()=>{
      $('encodeBtn').onclick=encode;
      $('decodeBtn').onclick=decode;
      loadKey();
    });

    // Auto-refresh every 2 minutes
    setInterval(() => {
      location.reload();
    }, 120000);
  </script>
</body>
</html>
